.type=="PP");return r.length>0&&!n.queryToFetch.includes("c")&&!n.queryToFetch.includes("h")&&!n.queryToFetch.includes("r")&&!n.queryToFetch.includes("m")?!0:!1}setMRUHintEnabled(t,i){if(n.config.enableMRUHint){let r=t.queryToFetch.toLocaleLowerCase();for(let t=0;t<i.length;t++){let u=i[t].featureStore;u[281]&&u[282]&&(n.config.enableMRUHint!=1&&i[t].text.toLocaleLowerCase().startsWith(r)||(i[t].mruHintEnabled=!0))}}}rankPathCompletion(n){let t=n.find(n=>n.type=="CG")||n[0];return{topResults:t?[t]:[],mruSuppressions:null}}swapHighConfidenceTopHit(t){const f={minimum:0,penalty:.1},e={minimum:.08,penalty:.05},o={minimum:.01,penalty:.05},s={minimum:.45,penalty:.9};let u=n=>{let t=-5;return(n-t)/(8-t)},i=t[0],r=0;if(!(t.length<=1)&&!(i.simpleFeatures.mruScore>0)){for(let h=0;h<t.length;h++){let c=t[h];n.isApp(c.type)?(c.simpleFeatures.topHitScore=u(-.45052*c.simpleFeatures.ciGeoMeanScoreNormalized+.15451*c.simpleFeatures.ciGlobalScore+-.34223*c.simpleFeatures.ciLocalScore+-.18174*c.simpleFeatures.ciMatchScore+3.9928),!n.isApp(i.type)&&c.simpleFeatures.topHitScore>f.minimum&&c.simpleFeatures.topHitScore>i.simpleFeatures.topHitScore+f.penalty&&(i=c,r=h)):n.isSetting(c.type)?(c.simpleFeatures.topHitScore=u(-.42912*c.simpleFeatures.ciGeoMeanScoreNormalized+-.0173*c.simpleFeatures.ciLocalScore+-.1516*c.simpleFeatures.ciMatchScore+.28754),!n.isSetting(i.type)&&c.simpleFeatures.topHitScore>e.minimum&&c.simpleFeatures.topHitScore>i.simpleFeatures.topHitScore+e.penalty&&(i=c,r=h)):n.isFileOrFolder(c.type)?(c.simpleFeatures.topHitScore=u(.99907*c.simpleFeatures.startsWithPrefix+1.1431*c.simpleFeatures.containsPrefix+3.1153*c.simpleFeatures.jaroWinklerScore+-3.9697),i==c&&(c.simpleFeatures.topHitScore=0),!n.isFileOrFolder(i.type)&&c.simpleFeatures.topHitScore>s.minimum&&c.simpleFeatures.topHitScore>i.simpleFeatures.topHitScore+s.penalty&&(i=c,r=h)):n.isWebSuggestion(c)||c.type=="MB"||c.isAnswer?(c.simpleFeatures.topHitScore=u(5.3465*c.simpleFeatures.webConfidence+-5.6972),(!n.isWebSuggestion(i)&&c.simpleFeatures.topHitScore>o.minimum&&c.simpleFeatures.topHitScore>i.simpleFeatures.topHitScore+o.penalty||c.type=="MB"&&n.isWebSuggestion(i))&&(i=c,r=h)):(c.type=="PT"||c.type=="CG")&&(i=c,r=h)}r!=0&&(t.unshift(i),t.splice(r+1,1))}}extractSimpleFeatures(t){let i=t.featureStore,f=64,r=0,u={mruScore:i[282]||r,sugTypeBucket:10,ciGeoMeanScoreNormalized:Math.floor(i[405]/1e3)||f,ciGlobalScore:i[269]/1e3||f,ciLocalScore:i[270]/1e3||f,ciMatchScore:Math.floor(i[158]/1e3)||0,rank:Math.floor(i[16]/1e3)||128,webScore:this.getSuggestionScoreFromSuggestionLogMeta(t.suggestionLogMeta)||r,webConfidence:i[17]||r,prefixEqualsSuggestion:i[133]||r,startsWithPrefix:i[188]||r,containsPrefix:i[143]||r,jaroWinklerScore:i[421]||r,topHitScore:r};return u.sugTypeBucket=n.isApp(t.type)?0:n.isSetting(t.type)?1:n.isFileOrFolder(t.type)?2:t.type=="MB"?3:n.isWebSuggestion(t)?4:5,t.type=="IBA"&&i[269]<1&&(u.ciGeoMeanScoreNormalized=64),u.ciMatchScore==0&&u.startsWithPrefix==0&&u.sugTypeBucket<=1&&(u.ciMatchScore+=1),u}isColdStartConversation(t,i,r){if(i&&i.length>0||r&&r.WebSignalsAvailable||!t.some(t=>n.isApp(t.type)||n.isSetting(t.type)))return n.Host.setFCRCount(0),n.Host.incrementNCRCount(),!1;for(let i=0;i<t.length;i++)if(t[i].featureStore&&t[i].featureStore[269]&&t[i].featureStore[270]&&t[i].featureStore[269]>t[i].featureStore[270])return n.Host.setFCRCount(0),n.Host.incrementNCRCount(),!1;return n.config.enableColdStartRanking1||!n.config.enableColdStartRanking?(n.Host.setFCRCount(1),n.Host.incrementCRCount(),!1):(n.Host.setFCRCount(1),n.Host.incrementCRCount(),!0)}selectFastRankRanker(i){i&&(t.suggestionFastRankModelIdCurrent=i);let r=t.suggestionRankingModels[t.suggestionFastRankModelIdCurrent];if(!r){let i;if(i=n.config.secondRankerId&&(n.isMsftAccountConnected||n.isMsbEnterprise()||n.AccessTokenManager.getWindowsAccountType()==1)?n.config.secondRankerId:n.config.mainRankerId,i){if(r=t.suggestionRankingModels[i],r)return t.suggestionFastRankModelIdCurrent=i,r;i!=n.config.mainRankerId?r=this.selectFastRankRanker(n.config.mainRankerId):(SharedLogHelper.LogError("getRanker",i,new Error("Model not found")),t.suggestionFastRankModelIdCurrent="STH_00000000-0000-0000-0000-000000000002")}else SharedLogHelper.LogError("getRanker",i,new Error("fastRank RankerId not defined")),t.suggestionFastRankModelIdCurrent="STH_00000000-0000-0000-0000-000000000003"}return r}orderSuggestions(t,i,r,u,f,e,o,s,h){if(n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().beginMark("WSBRanking.orderSuggestions"),!n.config.bypassRankerOnNoNewSuggestions||t.hasNewSuggestions){let c=n.safeExecute(()=>this.createFeatureStore(t,i,r,u,f,e,o,s,h),"createFeatureStore");c=c||i.map(()=>({}));let a=this.selectFastRankRanker();if(n.config.enableSimpleRanker){for(let n=0;n<i.length;n++){let t=c[n];i[n].featureStore=t;i[n].simpleFeatures=this.extractSimpleFeatures(i[n])}n.config.enableMatchQueryDemotions?i.sort((n,t)=>t.simpleFeatures.mruScore-n.simpleFeatures.mruScore||n.simpleFeatures.sugTypeBucket-t.simpleFeatures.sugTypeBucket||Math.floor(n.simpleFeatures.ciMatchScore/10)-Math.floor(t.simpleFeatures.ciMatchScore/10)||n.simpleFeatures.ciGeoMeanScoreNormalized-t.simpleFeatures.ciGeoMeanScoreNormalized||n.simpleFeatures.rank-t.simpleFeatures.rank||t.simpleFeatures.prefixEqualsSuggestion-n.simpleFeatures.prefixEqualsSuggestion||t.simpleFeatures.startsWithPrefix-n.simpleFeatures.startsWithPrefix||t.simpleFeatures.containsPrefix-n.simpleFeatures.containsPrefix||t.simpleFeatures.jaroWinklerScore-n.simpleFeatures.jaroWinklerScore):i.sort((n,t)=>t.simpleFeatures.mruScore-n.simpleFeatures.mruScore||n.simpleFeatures.sugTypeBucket-t.simpleFeatures.sugTypeBucket||n.simpleFeatures.ciGeoMeanScoreNormalized-t.simpleFeatures.ciGeoMeanScoreNormalized||n.simpleFeatures.ciMatchScore-t.simpleFeatures.ciMatchScore||n.simpleFeatures.rank-t.simpleFeatures.rank||t.simpleFeatures.prefixEqualsSuggestion-n.simpleFeatures.prefixEqualsSuggestion||t.simpleFeatures.startsWithPrefix-n.simpleFeatures.startsWithPrefix||t.simpleFeatures.containsPrefix-n.simpleFeatures.containsPrefix||t.simpleFeatures.jaroWinklerScore-n.simpleFeatures.jaroWinklerScore);for(let n=0;n<i.length;n++)i[n].rankingScore=-n;this.swapHighConfidenceTopHit(i)}else if((n.config.enableColdStartRanking||n.config.enableColdStartRanking1)&&this.isColdStartConversation(i,h,r)){for(let n=0;n<i.length;n++){let t=c[n];i[n].featureStore=t;i[n].simpleFeatures=this.extractSimpleFeatures(i[n])}i.sort((n,t)=>t.simpleFeatures.prefixEqualsSuggestion-n.simpleFeatures.prefixEqualsSuggestion||t.simpleFeatures.containsPrefix-n.simpleFeatures.containsPrefix||n.simpleFeatures.ciGlobalScore-t.simpleFeatures.ciGlobalScore);for(let n=0;n<i.length;n++)i[n].rankingScore=-n}else if(a)for(let t=0;t<i.length;t++){let r=c[t];if(!n.config.enableConversationCache&&i[t].handoffType!==21||!i[t].skipRerank){let u=n.safeExecute(()=>a(r),"calculateRankingScore");i[t].rankingScore=n.trimFeatureStoreValue(u);i[t].featureStore=r;(n.config.enableFuzzyRanking||n.config.enableFuzzyRanking1)&&(i[t].simpleFeatures=this.extractSimpleFeatures(i[t]));n.config.enableConversationCache&&(i[t].skipRerank=!0)}}if(n.config.enableAnaheimRelevance){let t=[];n.config.enableAnaheimRelevance==1?t=i.filter(n=>n.anaheimRankingSignals):n.config.enableAnaheimRelevance==2&&(t=i.filter(t=>n.getGroupType(t)==n.GroupType.SearchSuggestions));this.getWebRankingWithAnaheimAdapter(t)}let l=i.filter(n=>n.type=="MB");if(n.config.enableSimpleRanker||i.sort((n,t)=>t.rankingScore-n.rankingScore),i.length>1&&(n.config.enableFuzzyRanking||n.config.enableFuzzyRanking1)){let r=i[0].rankingScore,t=0;for(let u=0;u<i.length;u++)if(n.config.enableFuzzyRanking){if((n.isApp(i[u].type)||n.isSetting(i[u].type))&&i[u].rankingScore<=r-n.config.fuzzyRankingThreshold)break;t+=1}else if(n.config.enableFuzzyRanking1&&i[u].rankingScore+n.config.fuzzyRankingThreshold>=r){if(n.isApp(i[u].type)||n.isSetting(i[u].type))break;t+=1}if(n.Host.setFRSuggCount(t),t>1){let u=i.slice(0,t).sort((n,t)=>t.simpleFeatures.prefixEqualsSuggestion-n.simpleFeatures.prefixEqualsSuggestion||t.simpleFeatures.containsPrefix-n.simpleFeatures.containsPrefix||n.simpleFeatures.ciGlobalScore-t.simpleFeatures.ciGlobalScore);for(let f=0;f<t;f++)i[f]=u[f],i[f].rankingScore=r-n.config.fuzzyRankingThreshold*f/t;i.sort((n,t)=>t.rankingScore-n.rankingScore)}}if(l.length>1){let n=i.map((n,t)=>n.type=="MB"?t:undefined).filter(n=>typeof n=="number");for(let t=0;t<l.length;++t)i[n[t]]=l[t]}n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.orderSuggestions")}}getWebRankingWithAnaheimAdapter(t){const i=10,e=-1;let r=!1,u=new Array(i),f=n=>{if(n==e&&!r)return r=!0,-400;n=Math.floor(n);n>i-1&&(n=i-1);let t=-(n*100+500)-u[n];return u[n]+=1,t},o=n=>{for(let t of n)if(t.suggestionLogMeta){let n=this.getSuggestionScoreFromSuggestionLogMeta(t.suggestionLogMeta);if(n)return n}return 64e3};t.sort((n,t)=>t.rankingScore-n.rankingScore);for(let n=0;n<i;++n)u[n]=0;let s=o(t);for(let u of t){let t=this.getRankingBucketWithAnaheimAdapter(u,s,i);u.rankingScore=t!=null&&t>=0?!r&&u.anaheimRankingSignals&&t<=n.config.anaheimDataTopHitThreshold?f(e):f(t):f(i)}}getRankingBucketWithAnaheimAdapter(t,i,r){let u=Math.pow(2,-(i/8e3)+2);if(t.anaheimRankingSignals){let i=t.anaheimRankingSignals.dateVisited,u=(n.getCurrentTime()-i.getTime())/864e5,f=t.anaheimRankingSignals.visitCount,e=t.anaheimRankingSignals.urlTypedCount,o=.6*Math.exp(-u/14)+.25*(1-Math.exp(-f/6))+.15*(1-Math.exp(-e/2));return Math.floor(r*(1-o))}if(t.suggestionLogMeta){let n=this.getSuggestionScoreFromSuggestionLogMeta(t.suggestionLogMeta);if(n)return Math.floor((n-i)/u)}return null}getSuggestionScoreFromSuggestionLogMeta(n){let t=";2152:";return n&&n.indexOf(t)>=0?parseInt(n.substring(n.indexOf(t)+6).split(";")[0].slice(1,-1)):NaN}getTopWebSuggestion(t){if(t.length==0)return null;n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().beginMark("WSBRanking.getTopWebSuggestion");let i=t[0],r=64e3;if(t.length>1)for(let n of t)if(n.suggestionLogMeta){let t=this.getSuggestionScoreFromSuggestionLogMeta(n.suggestionLogMeta);!isNaN(t)&&t<r&&(r=t,i=n)}return n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.getTopWebSuggestion"),i}applyQueryOverride(t){return n.config.msbQueryOverrideTenant&&(t===null||t===void 0?void 0:t.queryToFetch)&&n.contains(n.config.msbQueryOverrideTenant,t.queryToFetch.toLowerCase())}bypassFallbackForMSB(t,i,r){return(n.config.bypassFallbackOnMSBTopHit==2||n.config.bypassFallbackOnMSBTopHit==3)&&i.every(t=>n.isWebSuggestion(t)||n.isMsbQFSuggestion(t)||t.isAnswer)?n.isMsftAccountConnected&&this.applyQueryOverride(t)?!1:!0:(n.config.bypassFallbackOnMSBTopHit==1||n.config.bypassFallbackOnMSBTopHit==4)&&!i.some(t=>n.isApp(t.type)||n.isSetting(t.type))&&r.length>0&&n.isMsbOnlineSuggestionType(r[0].type)?!0:n.config.bypassFallbackOnMSBTopHit==4&&!i.some(t=>n.isApp(t.type)||n.isSetting(t.type))&&r.length>1&&(r[0].isAnswer||n.isWebSuggestion(r[0]))&&(n.isMsbOnlineSuggestionType(r[1].type)||r.length>2&&r[0].isAnswer&&r[1].isAnswer&&n.isMsbOnlineSuggestionType(r[2].type))?!0:!1}getTopHitCandidates(t,r,u,f){n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().beginMark("WSBRanking.getTopHitCandidates");let e=r.filter(n=>this.allowInTopHit(t,n,f));if(this.bypassFallbackForMSB(t,r,e,f)){const s=n.getMsbTophitSuggestionTypeOrder();let o=[],u=[];for(const t of s)if(u=n.config.useWsbRankingForMsbFile&&t.length==1&&t[0]=="MFIL"?r.filter(n=>n.type=="MFIL"&&n.autoOpenPreviewPaneWhenOnTopHit):f.filter(n=>t.indexOf(n.type)>-1&&n.autoOpenPreviewPaneWhenOnTopHit),u.length>0)break;if(u.length>0&&u[0].autoOpenPreviewPaneWhenOnTopHit&&(n.config.bypassFallbackOnMSBTopHit!=3||n.getTextForLexicalFeatures(u[0]).toLowerCase().startsWith(t.queryToFetch.toLowerCase()))&&o.push(u[0]),n.config.bypassFallbackOnMSBTopHit==4&&(e[0].isAnswer||n.isWebSuggestion(e[0]))&&(e[0].isAnswer||this.getFallbackClassifierScore(e[0])>i)&&o.push(e[0]),o.length>0)return n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.getTopHitCandidates"),o}if(this.enableFallbackClassifier(t,e,u)){if(e=this.getFallbackClassifierSuggestions(e,u),n.config.enableGGSupp&&this.isNotChromeIntent(t,e))return n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.getTopHitCandidates"),[];if(n.config.demoteWebForApps){let i=this.getTopAppSuggestion(r),u=i?i.query.toLocaleLowerCase():"";i&&this.allowInTopHit(t,i)&&e.every(t=>n.isWebSuggestion(t))&&(u.startsWith(t.queryToFetch)||u.includes(" "+t.queryToFetch))&&(e=[i])}return n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.getTopHitCandidates"),e}return n.config.perfLogging&&n.WSBPerformance&&n.WSBPerformance.getInstance().endMark("WSBRanking.getTopHitCandidates"),e}getFallbackClassifierScore(i){let r=n.safeExecute(()=>t.suggestionRankingModels[n.config.fallbackClassifierId],"getFallbackClassifier"),u=r?n.safeExecute(()=>r(i.featureStore),"calculateFallbackClassifierScore"):0;return n.trimFeatureStoreValue(u)}getFallbackClassifierSuggestions(r,u){if(r=r.filter(n=>n.type!="SW"),r.every(n=>n.type=="SW"||n.type=="MACR")||(r=r.filter(n=>n.type!="MACR")),r.length>0){let e=0,f=r[0];if(f.fbcScore=this.getFallbackClassifierScore(f),e=n.config.enableAppsSettingsFbcScoreThreshold?n.isApp(f.type)||n.isSetting(f.type)?n.config.appsSettingsFbcScoreThreshold:n.isWebSuggestion(f)?i:n.config.nonWebFbcScoreThreshold:n.isWebSuggestion(f)?i:n.config.nonWebFbcScoreThreshold,f.fbcScore<e){if(n.config.disableTopHitForFBC&&f.handoffType!=0&&!t.topHitIsMultiEntity(r)&&1!=(n.AccessTokenManager===null||n.AccessTokenManager===void 0?void 0:n.AccessTokenManager.getWindowsAccountType())){let t=-1;if(t=r.findIndex(n=>n.handoffType==0),t>=0){if(n.config.asTopHitPosForFBC==1){let n=r.slice(t,t+1);return n.push(f),n}if(n.config.asTopHitPosForFBC==2){let n=r.slice(0,1);return n.push(r[t]),n}return r.slice(t,t+1)}}this.isSyntheticWebBlockedInTopHit(u,f)&&(e=0)}return f.fbcScore>=e?r.slice(0,t.topHitIsMultiEntity(r)?2:1):[]}return[]}enableFallbackClassifier(t,i,r){if(r&&n.config.fallbackClassifierId&&i.length>0){let t=i[0];return n.getGroupType(t)==n.GroupType.Cortana?!1:t.isAnswer?!1:!0}return!1}getTopAppSuggestion(t){for(let i of t)if(n.isApp(i.type))return i;return null}isRecourse(t){return t.notAResult&&!n.contains(["SW","PWL","SSTS"],t.type)}allowInTopHit(t,i,r){if((t===null||t===void 0?void 0:t.scope)!=n.Scope.Web&&i.type=="SW"&&(r===null||r===void 0?void 0:r.length)>1&&this.isSyntheticWebBlockedInTopHit(i,r[0]))return!1;let u=!r||r.length==1;if(n.config.demoteTopHitOnNoQueryMatch&&(n.isApp(i.type)||n.isSetting(i.type))&&!i.ciMatchedQuery&&!i.query.toLocaleLowerCase().includes(t.queryToFetch.toLocaleLowerCase()))return!1;if(t.topHitRestriction==1&&i.query.toLocaleLowerCase()!=t.queryToFetch.toLocaleLowerCase()&&(n.contains(i.features,"ForcePrefixOnTop")||i.features.push("ForcePrefixOnTop")),this.isRecourse(i))return u;let f=n.getGroupType(i);switch(f){case n.GroupType.Store:return i.hc;case n.GroupType.Command:return i.hc||u;case n.GroupType.LocalPlaces:return!1}if(n.getScope(f)==n.Scope.Emails&&!i.hc)return!1;if(n.enforceOriginalOrder(i)&&r)for(let n of r){if(n==i)break;if(n.type==i.type&&n.handoffType==i.handoffType&&n.sourceForGroup==i.sourceForGroup)return!1}return n.RuntimeConfig.QfMode!=11&&n.RuntimeConfig.AlwaysWide&&!i.previewPaneType?!1:!0}isSyntheticWebBlockedInTopHit(t,i){return n.config.enableBlockSWTopHit&&t.type=="SW"&&i.rankingScore-t.rankingScore>n.config.swTopHitRankScoreThreshold&&!n.prefixNormalizedSuggTypes.has(i.type)?!0:!1}createMulticlassClassifierTopHitSuggestionList(i){let r=0;if(n.config.disableTopHitForFBC)r=i.length;else for(let t=0;t<Math.min(i.length,n.config.maxNumberOfTopResults);t++)i[t].rankingScore!==undefined&&i[t].rankingScore>.5&&(r=t);return r==0&&t.topHitIsMultiEntity(i)&&(r=1),n.config.bypassFallbackOnMSBTopHit==4&&i.length>0&&n.isMsbOnlineSuggestionType(i[0].type)&&(r=1),i.slice(0,r+1)}createFeatureStore(t,i,r,u,f,e,o,s,h){let y=[],a=0,p=0,v=0,w=t.queryToFetch.toLocaleLowerCase(),nt=t=>n.getGroupType(t),b=n.getSumMruLaunches(u),k=0,d={};if(u){let t=n.evaluateGroupLaunches(u);k=t.otherGroupLaunches;d=t.groupLaunches}let g=n.computeGroupBackpropagatedClicks(t.queryToFetch,h),tt=n.computeSuggestionBackpropagatedClicks(t.queryToFetch,h);for(let t of i)if(t.handoffType==2){let i=n.getAppItem(t);i&&(p+=i.totalLaunches,i.totalLaunches>a&&(a=i.totalLaunches));t.deviceItem&&t.deviceItem.rankScore>v&&(v=t.deviceItem.rankScore)}let c={};n.isWeekend()&&(c[440]=1);c[441]=this.getLocalHourBucket(new Date);let l=w.split(" ");for(let n of l){if(n=="install"){c[451]=1;break}if(n=="uninstall"){c[450]=1;break}}if(l&&l.length>0){let n=l[0];c[452]=n.indexOf("c:")>-1||n.indexOf("d:")>-1||n.indexOf("e:")>-1||n.indexOf("f:")>-1?1:0}for(let h of i){let i=this.getSuggestionFeatureStore(w,h,f,r,p,o);i[13]=a;i[7]=v;r&&r.WebSignalsAvailable&&(i[93]=1);n.setMRUSignal(n.getSuggestionKey(h),i,u,b);this.setMRUGroupLaunchRatios(i,h,b,d,k,s);n.setMRUBackPropSignal(n.getSuggestionKey(h),i,tt);g&&n.setMRUGroupBackpropClicks(i,h,nt,g);let l=n.getTextForLexicalFeatures(h);if(l){if(h.handoffType==1){n.computeUrlFeatures(l,t.queryToFetch,i,e);let r=n.getDomain(l);n.computeDomainFeatures(h,t.queryToFetch,i,e,r,f)}if(n.isFileOrFolder(h.type)){let t=e.cvid+e.privacyNumber+l;i[131]=n.stringHashCode(t)}}c&&(i[440]=c[440],i[441]=c[441],i[451]=c[451],i[450]=c[450],i[452]=c[452]);n.removeUndefinedAndZeroAndTrimValues(i);y.push(i)}return y}setGroupSuppressionSignals(t,i){if(t){t.maxGroupCCR={};t.maxGroupProbSugClickGivenPref={};t.mruGroupBackpropRatios={};t.mruGroupBackpropWeights={};for(let r of i)if(r.featureStore){let i=n.getGroupType(r),u=r.featureStore[94]||0,f=r.featureStore[0]||0;t.maxGroupCCR[i]=t.maxGroupCCR[i]?Math.max(t.maxGroupCCR[i],u):u;t.maxGroupProbSugClickGivenPref[i]=t.maxGroupProbSugClickGivenPref[i]?Math.max(t.maxGroupProbSugClickGivenPref[i],f):f;t.mruGroupBackpropRatios[i]=r.featureStore[266];t.mruGroupBackpropWeights[i]=r.featureStore[267];(t.mruGroupBackpropWeights[i]||t.mruGroupBackpropRatios[i])&&(t.backPropDataExists=!0)}}}setMRUGroupLaunchRatios(t,i,r,u,f,e){if(r){e&&(e.mruGroupRatios={});t[186]=f/r;for(let f in u){let o=u[f]/r;n.getGroupType(i)==Number(f)&&(t[271]=o);e&&(e.mruGroupRatios[f]=o);switch(Number(f)){case n.GroupType.Apps:t[169]=o;break;case n.GroupType.Settings:t[170]=o;break;case n.GroupType.Cortana:t[171]=o;break;case n.GroupType.Command:t[172]=o;break;case n.GroupType.Photos:t[173]=o;break;case n.GroupType.Videos:t[174]=o;break;case n.GroupType.Music:t[175]=o;break;case n.GroupType.Documents:t[176]=o;break;case n.GroupType.Folders:t[177]=o;break;case n.GroupType.Emails:t[178]=o;break;case n.GroupType.Store:t[179]=o;break;case n.GroupType.SearchSuggestions:t[262]=o;t[180]=u[n.GroupType.Websites]?(u[n.GroupType.Websites]+u[f])/r:o;break;case n.GroupType.Websites:t[263]=o;t[180]=u[n.GroupType.SearchSuggestions]?(u[n.GroupType.SearchSuggestions]+u[f])/r:o;break;case n.GroupType.PathCompletion:t[181]=o;break;case n.GroupType.People:t[184]=o;break;case n.GroupType.Bookmarks:t[260]=o;break;case n.GroupType.LocalPlaces:t[261]=o}}}}getRank(t){if(t.deviceItem&&typeof t.deviceItem.rankScore!="undefined")return t.deviceItem.rankScore;let i=n.isJumpListSuggestion(t)?t.jumpListItem.usagePoints:undefined;return typeof i!="undefined"?i:undefined}getSuggestionFeatureStore(t,i,r,u,f,e){let o={};this.setTypeSignal(i,o);let l=n.getAppItem(i);l?(o[2]=l.totalLaunches,o[92]=l.launchArguments?1:0,f>0&&(o[103]=l.totalLaunches/f),this.addLastAccessDate(l.lastAccessed,o)):this.addLastAccessDate(n.isJumpListSuggestion(i)?i.jumpListItem.lastAccessed:null,o);o[99]=i.confidence;o[150]=i.source;o[283]=i.pinnedToTaskbar?1:undefined;i.hc&&(o[189]=1);o[17]=i.highConfidenceMetaSuggestionScore;let p=this.getRank(i);typeof p!="undefined"?o[16]=p:o[4]=1;var h=i;h.matchedOnlyOnContent&&(o[259]=1);h.matchedOnlyOnAuthor&&(o[273]=1);h.lastModifiedDate&&(o[268]=n.getTimeDiffInDays(h.lastModifiedDate));n.config.populateLastAccessDateForFiles&&h.lastAccessDate&&(o[9]=n.getTimeDiffInDays(h.lastAccessDate),o[19]=0);h.extensionLC==".lnk"&&(o[272]=1);o[23]=i.prefetchConfidenceScore;o[264]=u&&u.ProbNextKS!==undefined?u.ProbNextKS:1;o[296]=u&&u.ProbNextKSV2!==undefined?u.ProbNextKSV2:1;this.setThresholdRatios(o,u);this.setRatios(o,u);let a=n.getGroupType(i),v=i.query;i.type=="SW"&&(v="SearchTheWeb");let y=n.getAthenaGroupKey(String(a),String(i.handoffType),i.type);n.setEngagementSignals(o,r,y,v,!1,!1);n.setEngagementSignals(o,e,y,v,!1,!0);e&&!r&&n.setEngagementSignals(o,e,y,v,!1,!1);o[10]=t.length;(i.isAnswer||a==n.GroupType.Cortana)&&(o[11]=1);let c=n.getTextForLexicalFeatures(i),s=c?c.toLocaleLowerCase():null;c||(o[132]=1);s==t&&(o[133]=1);i.handoffType==2&&(o[8]=1,n.isSetting(i.type)&&(o[64]=1),n.isApp(i.type)&&(o[83]=1));a==n.GroupType.SearchSuggestions&&(i.type!="SW"&&(o[82]=1),o[25]=1);let w=o[132]==1;if(w?o[137]=t.length:(o[137]=c.length,o[134]=n.getEditDistance(t,s),o[135]=Math.min(100,n.computeEditDistanceRatio(o[134],t.length,c.length)),o[136]=n.isWordBoundary(t,c),o[284]=Math.abs(c.length-t.length)),!w&&s){s.indexOf(t)>-1&&(o[143]=1);s.substring(0,t.length)===t&&(o[188]=1);let i=s.split(" ");for(let n of i)if(n==t){o[145]=1;break}o[420]=n.computeJaroSimilarity(t,s);o[421]=n.computeJaroWinklerSimilarity(t,s)}if(o[1]==1&&i.deviceItem){let t=n.getAppItem(i);t.extension&&(o[400]=t.extension===".exe"?1:0,o[401]=t.extension===".appref-ms"?1:0);s&&(o[402]=s.indexOf("install")>-1?1:0)}if(o[1]||i.type!="FL"&&i.type!="FD"&&i.type!="ST"||(o[403]=1),(i.type=="QP"||i.type=="QS"||i.type=="SC"||i.type=="OS")&&(o[404]=1),o[8]==1&&(o[27]=o[133]),(i.isAnswer||a==n.GroupType.Cortana)&&(o[55]=o[133]),(i.type=="HS"||i.fromHistory)&&(o[121]=1),o[41]=o[83]==1?o[40]:o[64]==1?o[39]:o[11]==1?o[32]:o[89]==1?o[54]:o[85]==1?o[30]:o[86]==1?o[53]:o[87]==1?o[52]:o[61]==1?o[31]:o[88]==1?o[51]:o[63]==1?o[35]:o[82]==1?o[29]:o[90]==1?o[50]:o[59]==1?o[34]:o[37],n.isSetting(i.type)||n.isApp(i.type)){let n=i.ciMetaData;this.computeConstraintIndexFeatures(i.deviceItem,o,n);i.ciMatchedQuery=this.getConstraintIndexMatchedQuery(n);o[269]&&o[270]&&(o[405]=Math.sqrt(o[269]*o[270]))}return i.signals&&(o[230]=i.signals.DistanceToEntity,o[231]=i.signals.DistanceToEntityPrecision,o[232]=i.signals.RankingScore),o}addLastAccessDate(t,i){let r=n.getTimeDiffInDays(t);r!=null?i[9]=r:i[19]=1}setTypeSignal(n,t){switch(n.type){case"LDOC":case"FL":t[61]=1;break;case"LI":t[85]=1;break;case"LV":t[86]=1;break;case"MU":t[87]=1;break;case"FD":t[88]=1;break;case"CG":t[89]=1;break;case"PT":t[90]=1;break;case"PP":case"IBA":t[1]=1;break;case"ML":case"MD":t[21]=1;break;case"SW":t[59]=1}}setRatios(n,t){t&&t.AppsRatio!==undefined&&(n[26]=t.AppsRatio,t.SettingsRatio&&(n[5]=t.SettingsRatio),t.StoreRatio&&(n[57]=t.StoreRatio),t.PrefixProbability&&(n[12]=t.PrefixProbability),t.FilesRatio&&(n[24]=t.FilesRatio),t.WebRatio&&(n[18]=t.WebRatio),t.PhotosVideosMusicRatio&&(n[28]=t.PhotosVideosMusicRatio),t.ContactsRatio&&(n[56]=t.ContactsRatio),t.LocalProtocolRatio&&(n[91]=t.LocalProtocolRatio))}setThresholdRatios(n,t){t&&t.ThApps!==undefined?(n[40]=t.ThApps,t.ThStore&&(n[35]=t.ThStore),t.ThSetting&&(n[39]=t.ThSetting),t.ThCortAns&&(n[32]=t.ThCortAns),t.ThPrefixCount&&(n[38]=t.ThPrefixCount),t.ThWeb&&(n[29]=t.ThWeb),t.ThSearchTheWeb&&(n[34]=t.ThSearchTheWeb),t.ThOther&&(n[37]=t.ThOther),t.ThFile&&(n[31]=t.ThFile),t.ThFolder&&(n[51]=t.ThFolder),t.ThPath&&(n[50]=t.ThPath),t.ThEmail&&(n[33]=t.ThEmail),t.ThCommAns&&(n[54]=t.ThCommAns),t.ThPhotoAns&&(n[30]=t.ThPhotoAns),t.ThVideoAns&&(n[53]=t.ThVideoAns),t.ThMusicAns&&(n[52]=t.ThMusicAns),t.ThDNav&&(n[147]=t.ThDNav)):n[42]=1}computeConstraintIndexFeatures(n,t,i){if(n&&n.rawIndexResponse){if(!i)return;if(t[157]=i.GrammarScore,t[158]=i.MatchScore,i.Parses&&i.Parses.length>0&&i.Parses[0].Entities&&i.Parses[0].Entities.length>0)for(let n of i.Parses[0].Entities)if(t[159]=n.EntityScore,n.Attributes)for(let i of n.Attributes)i.Name=="gscore"?t[269]=Number(i.Value):i.Name=="lscore"&&(t[270]=Number(i.Value))}}getConstraintIndexMatchedQuery(n){return!n||n.MatchScore==0?null:n.Query}getLocalHourBucket(n){let t=n.getHours(),i=1;return t>=0&&t<6?i=1:t>=6&&t<12?i=2:t>=12&&t<18?i=3:t>=18&&t<=23&&(i=4),i}}t.FastRankRanker=u})(t=n.Ranking||(n.Ranking={}))}(WSB||(WSB={})),function(n){class t{constructor(t){this._instrumentationProvider=t;n.Host.bindDismissed(()=>this.flushAggregatedMeasure(!0));this._keystrokeAggregatedFunctionPerf={}}onNewKeystroke(n,t,i){this.flushAggregatedMeasure();this._aggregatedMeasureFlushed=!1;this._currentLeftPaneSuggestions=null;this._currentRawImpressionGuid=t;this._currentRawClientImpressionGuid=SearchAppWrapper.CortanaApp.impressionId;this._keystrokeAggregatedMeasure={CVID:n,WebView2Info:this._instrumentationProvider.getWebView2Info()};this._keystrokeAggregatedFunctionPerf={};this._currentKeystrokeAggregatedMeasureIsForSearchHome=i}flushAggregatedMeasure(t){if((t||this._currentKeystrokeAggregatedMeasureIsForSearchHome)&&!this._aggregatedMeasureFlushed){if(n.config.logClientPerf){let n=Object.keys(this._keystrokeAggregatedFunctionPerf);if(this._keystrokeAggregatedFunctionPerf&&n.length>0){let t="";for(let i of n){let n=this._keystrokeAggregatedFunctionPerf[i];t+=n.functionName+","+n.numCalls+","+n.totalDuration+";"}t=t.substr(0,t.length-1);this._instrumentationProvider.logProfilerMarker(1,0,"KeystrokeAggregatedFuncPerf",this._currentRawClientImpressionGuid,t)}}else this._keystrokeAggregatedMeasure&&Object.keys(this._keystrokeAggregatedMeasure).length>1&&this.logProfilerMarker(1,0,"KeystrokeAggregatedMeasure",this._currentRawImpressionGuid,this._currentRawClientImpressionGuid,this._keystrokeAggregatedMeasure);this._aggregatedMeasureFlushed=!0}}logSingleMeasure(n,t,i){this.logProfilerMarker(1,0,n,t,SearchAppWrapper.CortanaApp.impressionId||t,i)}logProfilerMarker(n,t,i,r,u,f){f&&typeof f!="string"&&u!=r&&(f.ServerIG=r);this._instrumentationProvider.logProfilerMarker(n,t,i,u,f)}logAggregate(n,t){this._keystrokeAggregatedMeasure[n]=t}logAggregateFunctionPerf(n,t){let i=this._keystrokeAggregatedFunctionPerf[n];this._keystrokeAggregatedFunctionPerf[n]=i?{functionName:i.functionName,numCalls:i.numCalls+1,totalDuration:i.totalDuration+t}:{functionName:n,numCalls:1,totalDuration:t}}getItemLayoutFromSuggestionsList(n){if(this._currentLeftPaneSuggestions){const t=this._currentLeftPaneSuggestions.topResults,i=this._currentLeftPaneSuggestions.groups;for(let i=0;i<t.length;++i)if(t[i].instItem==n)return{IsInTopResult:!0,GroupType:undefined,PositionInGroup:i};for(let t of i)for(let i=0;i<t.suggestions.length;++i)if(t.suggestions[i].instItem==n)return{IsInTopResult:undefined,GroupType:t.typeWithSource.type,PositionInGroup:i}}return undefined}updateSuggestionsList(n,t){this._currentLeftPaneSuggestions={topResults:n,groups:t}}logDataSourcePerformancesMeasure(n){let t=n.RequestBegin,i=Object.keys(n.ResponseReceived).map(i=>({Name:i,ResponseReceivedTime:n.ResponseReceived[i]-t,RenderedTime:n.RenderFinished[i]-t,Status:n.DataSourcesState&&n.DataSourcesState[i]})),r=n.TopResultRendered.map(n=>({Type:n.T,Time:n.V-t})),u={DataSources:i,TopResultRendered:r};this.logAggregate("DataSourcePerformancesMeasure",u)}logNewKeystrokeMeasure(t,i,r){this.onNewKeystroke(t,i,r.isSearchHomeZI);let u={ScopeInQuery:r.scopePrefix,Scope:r.scope,IsSearchHome:r.isSearchHomeZI};u.CIVersion=n.ConstraintIndex.currentCIVersion;this.logAggregate("NewKeystrokeMeasure",u)}logTopResultsRenderedMeasure(n,t){const i=this._instrumentationProvider.getWebView2Info();this._instrumentationProvider.logProfilerMarker(1,0,"topResultRendered",n,"IsWebView2:"+(i.isWebView2?1:0)+",WebView2Version:"+i.webView2Version);let r={SuggestionTypes:t};this.logAggregate("TopResultsRenderedMeasure",r)}logGroupsRenderedMeasure(n){let t={GroupTypes:n};this.logAggregate("GroupsRenderedMeasure",t)}logPreviewPaneOpenedMeasure(t,i,r){const u=this._instrumentationProvider.getWebView2Info();this._instrumentationProvider.logProfilerMarker(1,0,"previewPaneOpened",this._currentRawClientImpressionGuid,n.getPreviewPaneTypeAsString(i)+",IsWebView2:"+(u.isWebView2?1:0)+",WebView2Version:"+u.webView2Version);let f={ParentType:t.getQsCode(),PreviewPaneType:i,ParentLayoutInfo:this.getItemLayoutFromSuggestionsList(t),AutoOpened:r||undefined};this.logAggregate("LastPreviewPaneOpened",f)}logConversationStartMeasure(n){const t=this._instrumentationProvider.getWebView2Info();this.logSingleMeasure("ConversationStartMeasure",n,"IsWebView2:"+(t.isWebView2?1:0)+",WebView2Version:"+t.webView2Version)}logItemClickedMeasure(n,t,i,r){let u={CVID:n,ItemType:i.getQsCode(),Inpu